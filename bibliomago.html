<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EL DESAF√çO DEL BIBLIOMAGO ‚Äî Librer√≠a Tertulia</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  :root{
    --neon:#7ef9ff;
    --neon-2:#ff7ef9;
    --dark:#071018;
    --paper:#EDE0C8;
    --accent:#ffd166;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#04121a 0%, #071018 60%, #0b0b0b 100%);font-family:'Press Start 2P', monospace;color:var(--neon);}
  .wrap{max-width:1000px;margin:20px auto;padding:18px;border:4px double rgba(255,255,255,0.03);box-shadow:0 0 40px rgba(0,255,200,0.04);min-height:640px;background:linear-gradient(180deg, rgba(2,10,12,0.5), rgba(0,0,0,0.6));position:relative;overflow:hidden;border-radius:14px;}
  header{ text-align:center;padding-top:6px;}
  h1{font-size:28px;margin:6px 0;color:var(--neon);text-shadow:0 0 12px rgba(126,249,255,0.2), 0 0 24px rgba(255,126,249,0.06);letter-spacing:1px;}
  .subtitle{font-size:10px;color:#bfeeee;margin-bottom:6px;}
  .marque{font-size:10px;color:#ffd;opacity:0.9;margin-bottom:10px;}
  .top3{display:flex;justify-content:center;gap:8px;margin:12px 0;}
  .podium{width:160px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.2));text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.6);}
  .gold{color:gold;text-shadow:0 0 12px rgba(255,215,0,0.4);}
  .silver{color:silver;text-shadow:0 0 12px rgba(200,200,255,0.12);}
  .bronze{color:#ffb07c;text-shadow:0 0 12px rgba(255,160,120,0.12);}
  .buttons{display:flex;justify-content:center;gap:12px;margin:12px 0;}
  button.big{padding:14px 18px;background:transparent;border:2px solid var(--neon);color:var(--neon);cursor:pointer;border-radius:8px;min-width:140px;}
  button.big:hover{background:var(--neon);color:#000;transform:translateY(-2px);box-shadow:0 0 30px rgba(126,249,255,0.12);}
  #particle-canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1;opacity:0.9;}
  main{position:relative;z-index:2;padding:10px;}
  /* Game area */
  .game-screen{display:none;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));border-radius:8px;min-height:420px;}
  .stats{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:12px;}
  .lives{color:#ff6b6b;}
  .score{color:var(--accent);}
  .clue{background:linear-gradient(180deg,#0b1919, #081010);border:2px dashed rgba(126,249,255,0.08);padding:18px;border-radius:6px;min-height:90px;display:flex;align-items:center;justify-content:center;font-size:13px;color:#dff; text-align:center;}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;}
  .opt{padding:12px;border:2px solid var(--neon);background:rgba(0,0,0,0.2);cursor:pointer;border-radius:6px;text-align:center;}
  .opt:hover{background:var(--neon);color:#000;transform:translateY(-2px);}
  .progressWrap{margin-top:12px;background:rgba(255,255,255,0.03);height:24px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);}
  .progressBar{height:100%;width:0%;background:linear-gradient(90deg,var(--neon),var(--neon-2));transition:width 450ms ease;}
  .progressText{font-size:10px;margin-top:6px;text-align:center;color:#cde;}
  .footerSmall{font-size:10px;color:#9ff;margin-top:8px;text-align:center;}

  /* popup ranking */
  .overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999;}
  .card{background:linear-gradient(180deg,#061518,#0a0a0a);padding:18px;border-radius:10px;min-width:320px;color:var(--neon);box-shadow:0 0 30px rgba(0,255,200,0.04);}
  .ranklist{max-height:360px;overflow:auto;margin-top:8px;}
  .rankItem{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;}
  .rankMedal{font-size:16px;margin-right:6px;}

  /* estampa */
  .stamp{width:720px;max-width:90vw;background:linear-gradient(180deg,#f8efd9,#e4d7b0);padding:20px;border-radius:10px;color:#111;font-family:Arial, Helvetica, sans-serif;text-align:center;display:none;}
  .stamp h2{margin:6px 0;color:#2a2a2a;}
  .stamp .meta{font-size:14px;color:#333;margin-top:8px;}

  /* responsive small */
  @media(max-width:720px){
    h1{font-size:18px;}
    .top3{flex-direction:column;align-items:center;}
    .podium{width:90%;}
    .options{grid-template-columns:1fr;}
    .stamp{width:92vw}
  }
</style>

</head>
<body>

<div class="wrap">
  <canvas id="particle-canvas"></canvas>

  <header>
    <h1>EL DESAF√çO DEL BIBLIOMAGO</h1>
    <div class="subtitle">‚ÄúSolo los elegidos descifran las p√°ginas del destino‚Ä¶‚Äù</div>
    <div class="marque">Librer√≠a Tertulia ‚Äì Arcade Retro ‚Äì 2025</div>

    <div class="top3">
      <div class="podium gold" id="p1">ü•á Bibliomago Supremo ‚Äî ‚Äî</div>
      <div class="podium silver" id="p2">ü•à Gran Erudito Arcano ‚Äî ‚Äî</div>
      <div class="podium bronze" id="p3">ü•â Aprendiz Ilustre ‚Äî ‚Äî</div>
    </div>

    <div class="buttons">
      <button class="big" id="startBtn">‚ñ∂ START</button>
      <button class="big" id="recordsBtn">üèÜ R√âCORDS</button>
      <button class="big" id="rulesBtn">üìú REGLAS</button>
      <button class="big" id="musicBtn">üîä M√öSICA</button>
    </div>
  </header>

  <main>
    <!-- GAME -->
    <div class="game-screen" id="gameScreen">
      <div class="stats">
        <div class="lives">Vidas: <span id="lives">‚ô•Ô∏é ‚ô•Ô∏é ‚ô•Ô∏é ‚ô•Ô∏é ‚ô•Ô∏é ‚ô•Ô∏é</span></div>
        <div class="score">Puntos: <span id="score">0</span></div>
      </div>

      <div class="clue" id="clue">Aqu√≠ aparecer√° la pista o silueta del libro...</div>

      <div class="options" id="options"></div>

      <div class="progressWrap">
        <div class="progressBar" id="progressBar"></div>
      </div>
      <div class="progressText" id="progressText">0 / 50 ‚Äî Rango: Ninguno</div>

      <div class="footerSmall">Responde correctamente para avanzar. ¬°Buena suerte, lector!</div>
    </div>

    <!-- POP-UPS -->
    <div class="overlay" id="overlayRecords">
      <div class="card">
        <h3>üèÜ TOP 10 ‚Äî R√âCORDS</h3>
        <div class="ranklist" id="ranklist"></div>
        <div style="text-align:center;margin-top:8px;"><button class="big" onclick="closeOverlay('overlayRecords')">Volver</button></div>
      </div>
    </div>

    <div class="overlay" id="overlayRules">
      <div class="card">
        <h3>üìú REGLAS</h3>
        <p style="font-size:12px;color:#bfe">‚Ä¢ 50 preguntas por partida (aleatorias respetando dificultad).<br>
        ‚Ä¢ No avanzas hasta responder correctamente.<br>
        ‚Ä¢ 6 vidas totales; cada error resta 1 vida.<br>
        ‚Ä¢ Rangos por avance: 25 / 40 / 50.<br>
        ‚Ä¢ Si quedas Top 3, se generar√° una estampa descargable.<br>
        ‚Ä¢ Puedes pausar/activar m√∫sica con el bot√≥n M√öSICA.<br>
        </p>
        <div style="text-align:center;margin-top:8px;"><button class="big" onclick="closeOverlay('overlayRules')">Volver</button></div>
      </div>
    </div>

    <!-- POST-GAME name input for ranking if needed -->
    <div class="overlay" id="overlayName">
      <div class="card">
        <h3>¬°Has entrado al TOP 10!</h3>
        <p>Escribe tu nombre (m√°x 20 caracteres):</p>
        <input id="playerName" style="width:100%;padding:10px;margin-bottom:8px;font-family:monospace">
        <div style="display:flex;gap:8px;justify-content:center;">
          <button class="big" onclick="submitName()">Guardar</button>
          <button class="big" onclick="closeOverlay('overlayName')">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- STAMP -->
    <div style="text-align:center;margin-top:14px;">
      <div id="stampArea" style="display:none;">
        <div class="stamp" id="stampCard">
          <h2 id="stampTitle">Bibliomago Supremo</h2>
          <div style="font-weight:bold;font-size:20px" id="stampName">Jugador</div>
          <div class="meta" id="stampMeta">Puntaje: 1200 ‚Äî 2025</div>
          <div style="margin-top:14px;"><button class="big" id="downloadStampBtn">üì• Descargar</button> <button class="big" id="shareStampBtn">üì§ Compartir</button> <button class="big" onclick="resetToMenu()">üîÅ Volver</button></div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Audio elements (use your own files or URLs) -->
<audio id="bgMusic" loop>
  <source src="musica.mp3" type="audio/mpeg">
</audio>
<audio id="sOk"><source src="ok.mp3" type="audio/mpeg"></audio>
<audio id="sErr"><source src="error.mp3" type="audio/mpeg"></audio>
<audio id="sLife"><source src="life.mp3" type="audio/mpeg"></audio>
<audio id="sRank"><source src="rankup.mp3" type="audio/mpeg"></audio>
<audio id="sWin"><source src="win.mp3" type="audio/mpeg"></audio>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Optional Firebase (if quieres ranking en la nube) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
/* ===========================
   CONFIGURACIONES INICIALES
   =========================== */

const TOTAL_REQUIRED = 50;
let lives = 6;
let score = 0;
let currentIndex = 0;
let sequence = []; // selected 50-question sequence
let usedQuestions = []; // indexes used
let musicOn = false;
let firebaseEnabled = false; // set true if you paste config and it initializes

// RANKING storage (fallback to localStorage if firebase not configured)
let rankingLocalKey = "bibliomago_ranking_v1";

/* ===========================
   PREGUNTAS (60 items)
   20 easy / 20 medium / 20 hard
   Each: {text, options:[...], correct:0..3, difficulty: 'easy'|'med'|'hard'}
   =========================== */
const QUESTIONS = [
  /* EASY 20 */
  {text:"¬øQui√©n escribi√≥ 'Cien a√±os de soledad'?", options:["Gabriel Garc√≠a M√°rquez","Mario Vargas Llosa","Pablo Neruda","Julio Cort√°zar"], correct:0, difficulty:"easy"},
  {text:"¬øCu√°l es el autor de 'Don Quijote'?", options:["Lope de Vega","Miguel de Cervantes","Federico Garc√≠a Lorca","Camilo Jos√© Cela"], correct:1, difficulty:"easy"},
  {text:"Personaje: un mago aprendiz con cicatriz. ¬øQui√©n es?", options:["Gandalf","Merl√≠n","Harry Potter","Dumbledore"], correct:2, difficulty:"easy"},
  {text:"¬øCu√°l novela tiene un personaje llamado 'Elizabeth Bennet'?", options:["Jane Eyre","Orgullo y prejuicio","Anna Karenina","Mujercitas"], correct:1, difficulty:"easy"},
  {text:"¬øQui√©n escribi√≥ '1984'?", options:["Aldous Huxley","George Orwell","Ray Bradbury","H. G. Wells"], correct:1, difficulty:"easy"},
  {text:"Objeto ic√≥nico: un anillo que domina. ¬øA qu√© saga pertenece?", options:["Narnia","El Se√±or de los Anillos","Harry Potter","Cr√≥nicas de la Dragonlance"], correct:1, difficulty:"easy"},
  {text:"¬øQu√© autor escribi√≥ 'El Principito'?", options:["Antoine de Saint-Exup√©ry","Victor Hugo","Albert Camus","√âmile Zola"], correct:0, difficulty:"easy"},
  {text:"¬øQui√©n es el autor de 'La sombra del viento'?", options:["Carlos Ruiz Zaf√≥n","Isabel Allende","Paulo Coelho","Javier Cercas"], correct:0, difficulty:"easy"},
  {text:"Objeto: ¬øQui√©n cre√≥ a 'Frankenstein' (novela)?", options:["Bram Stoker","Mary Shelley","Edgar Allan Poe","H. P. Lovecraft"], correct:1, difficulty:"easy"},
  {text:"Personaje: Sherlock Holmes. ¬øQui√©n es su creador?", options:["Agatha Christie","Arthur Conan Doyle","Edgar Wallace","Daphne du Maurier"], correct:1, difficulty:"easy"},
  {text:"¬øQu√© libro comienza con 'Call me Ishmael'?", options:["Moby Dick","El viejo y el mar","La Odisea","El guardi√°n entre el centeno"], correct:0, difficulty:"easy"},
  {text:"¬øCu√°l es la trilog√≠a de la Tierra Media de mayor fama?", options:["El Hobbit","El Se√±or de los Anillos","Las Cr√≥nicas de Narnia","La Rueda del Tiempo"], correct:1, difficulty:"easy"},
  {text:"Autor: 'Romeo y Julieta' pertenece a...", options:["Goethe","William Shakespeare","Lope de Vega","Tennessee Williams"], correct:1, difficulty:"easy"},
  {text:"¬øQu√© libro tiene a Katniss Everdeen como protagonista?", options:["Divergente","Los juegos del hambre","Percy Jackson","Maze Runner"], correct:1, difficulty:"easy"},
  {text:"¬øQui√©n escribi√≥ 'El nombre del viento'?", options:["Patrick Rothfuss","Brandon Sanderson","George R. R. Martin","Ursula K. Le Guin"], correct:0, difficulty:"easy"},
  {text:"Objeto literario: 'La pluma que escribe destinos' aparece en qu√© tipo de historias?", options:["Realismo contempor√°neo","Fantas√≠a","No ficci√≥n","Ensayo"], correct:1, difficulty:"easy"},
  {text:"¬øQui√©n escribi√≥ 'Fahrenheit 451'?", options:["Ray Bradbury","George Orwell","Kurt Vonnegut","Philip K. Dick"], correct:0, difficulty:"easy"},
  {text:"¬øLa saga 'Harry Potter' fue escrita por...?", options:["J.K. Rowling","C.S. Lewis","J.R.R. Tolkien","Suzanne Collins"], correct:0, difficulty:"easy"},
  {text:"Personaje: 'Atticus Finch' pertenece a...", options:["Matar a un ruise√±or","El gran Gatsby","To Kill a Mockingbird","Ambas A y C"], correct:2, difficulty:"easy"},
  {text:"¬øCu√°l obra es de Julio Cort√°zar?", options:["Rayuela","Cien a√±os de soledad","Pedro P√°ramo","El amor en los tiempos del c√≥lera"], correct:0, difficulty:"easy"},

  /* MEDIUM 20 */
  {text:"¬øQu√© autor escribi√≥ 'Beloved'?", options:["Toni Morrison","Alice Walker","Zadie Smith","Chimamanda Ngozi Adichie"], correct:0, difficulty:"med"},
  {text:"Objeto: 'Un grimorio con p√°ginas en blanco que reflejan deseos' es t√≠pico de...", options:["Realismo m√°gico","Fantas√≠a oscura","Ensayo","Novela hist√≥rica"], correct:1, difficulty:"med"},
  {text:"¬øQui√©n escribi√≥ 'El perfume'?", options:["Patrick S√ºskind","Thomas Mann","Stefan Zweig","Hermann Hesse"], correct:0, difficulty:"med"},
  {text:"Personaje: 'Humbert Humbert' aparece en...", options:["Lolita","Mrs Dalloway","La metamorfosis","El ruido y la furia"], correct:0, difficulty:"med"},
  {text:"¬øQui√©n es el autor de 'Crimen y castigo'?", options:["Dostoyevski","Tolst√≥i","Chejov","G√≥gol"], correct:0, difficulty:"med"},
  {text:"¬øQu√© obra es de Virginia Woolf?", options:["Mrs Dalloway","El gran Gatsby","El guardi√°n entre el centeno","La carretera"], correct:0, difficulty:"med"},
  {text:"Objeto: 'Un espejo que muestra vidas alternativas' pertenece a...", options:["Literatura fant√°stica","Filosof√≠a","No ficci√≥n","Manual t√©cnico"], correct:0, difficulty:"med"},
  {text:"¬øQu√© novela presenta a Meursault como protagonista?", options:["El extranjero","La n√°usea","La peste","Los hermanos Karam√°zov"], correct:0, difficulty:"med"},
  {text:"¬øQui√©n escribi√≥ 'El Se√±or Presidente'?", options:["Miguel √Ångel Asturias","Gabriel Garc√≠a M√°rquez","R√≥mulo Gallegos","Alejo Carpentier"], correct:0, difficulty:"med"},
  {text:"Personaje: 'Jean Valjean' aparece en...", options:["Los Miserables","Candide","Madame Bovary","El retrato de Dorian Gray"], correct:0, difficulty:"med"},
  {text:"¬øCu√°l escritor es sinonimo de 'realismo m√°gico' en Latinoam√©rica?", options:["Garc√≠a M√°rquez","Borges","Paz","Rulfo"], correct:0, difficulty:"med"},
  {text:"Objeto: 'Una carta sin remitente que cambia destinos' es recurso de...", options:["Novela epistolar","Poes√≠a","Teatro","Ensayos"], correct:0, difficulty:"med"},
  {text:"¬øQui√©n escribi√≥ 'Ana Kar√©nina'?", options:["Le√≥n Tolst√≥i","Fi√≥dor Dostoyevski","Lev Tolst√≥i","Nikol√°i Gogol"], correct:0, difficulty:"med"},
  {text:"¬øQu√© autor plante√≥ 'El Aleph'?", options:["Jorge Luis Borges","Octavio Paz","Pablo Neruda","Julio Cort√°zar"], correct:0, difficulty:"med"},
  {text:"Personaje: 'Lyra Belacqua' es de...", options:["His Dark Materials","Percy Jackson","Harry Potter","Narnia"], correct:0, difficulty:"med"},
  {text:"¬øQui√©n escribi√≥ 'La carretera'?", options:["Cormac McCarthy","Stephen King","John Steinbeck","Don DeLillo"], correct:0, difficulty:"med"},
  {text:"Objeto: 'Una br√∫jula que apunta a recuerdos' aparece en...", options:["Fantas√≠a","No ficci√≥n","Manual","Cr√≥nica"], correct:0, difficulty:"med"},
  {text:"¬øQu√© obra es de Isabel Allende?", options:["La casa de los esp√≠ritus","Pedro P√°ramo","El t√∫nel","La colmena"], correct:0, difficulty:"med"},
  {text:"Personaje: 'Rand al'Thor' pertenece a qu√© saga?", options:["La Rueda del Tiempo","Dune","Fundaci√≥n","El Archivo"], correct:0, difficulty:"med"},
  {text:"¬øQui√©n escribi√≥ 'Los heraldos negros' (poemas)?", options:["Cesar Vallejo","Pablo Neruda","Octavio Paz","Federico Garc√≠a Lorca"], correct:0, difficulty:"med"},

  /* HARD 20 */
  {text:"¬øQu√© novelista escribi√≥ 'La muerte de Artemio Cruz'?", options:["Carlos Fuentes","Octavio Paz","Juan Rulfo","Carlos Monsiv√°is"], correct:0, difficulty:"hard"},
  {text:"Objeto: 'Un c√≥dice que solo leen sombras' aparece en novela de...", options:["Fantas√≠a g√≥tica","Realismo","Ensayo hist√≥rico","Manual"], correct:0, difficulty:"hard"},
  {text:"Personaje: 'Molloy, Malone, The Unnamable' aparecen en obras de...", options:["Samuel Beckett","Franz Kafka","Albert Camus","Thomas Bernhard"], correct:0, difficulty:"hard"},
  {text:"¬øQui√©n escribi√≥ 'En busca del tiempo perdido'?", options:["Marcel Proust","James Joyce","Virginia Woolf","Franz Kafka"], correct:0, difficulty:"hard"},
  {text:"¬øQu√© autor escribi√≥ 'Ulises'?", options:["James Joyce","William Faulkner","Samuel Beckett","Vladimir Nabokov"], correct:0, difficulty:"hard"},
  {text:"¬øCu√°l obra es de Nabokov?", options:["Lolita","El extranjero","El amor en los tiempos del c√≥lera","El se√±or de las moscas"], correct:0, difficulty:"hard"},
  {text:"Personaje: 'Stephen Dedalus' aparece en...", options:["Retrato del artista adolescente","Ulises","Mrs Dalloway","Ambas A y B"], correct:3, difficulty:"hard"},
  {text:"¬øQui√©n escribi√≥ 'La n√°usea'?", options:["Jean-Paul Sartre","Albert Camus","Simone de Beauvoir","Samuel Beckett"], correct:1, difficulty:"hard"},
  {text:"Objeto: 'Un espejo que devora nombres' ‚Äî recurso t√≠pico de...", options:["Fantas√≠a oscura","Monograf√≠a","Ciencia pol√≠tica","Gu√≠a"], correct:0, difficulty:"hard"},
  {text:"¬øQu√© autor escribi√≥ 'La muerte de Ivan Illich'?", options:["Leo Tolstoy","Boris Pasternak","Lev Tolst√≥i","Nikol√°i Leskov"], correct:0, difficulty:"hard"},
  {text:"Personaje: 'Offred' es protagonista de...", options:["El cuento de la criada","El extranjero","La colmena","La casa verde"], correct:0, difficulty:"hard"},
  {text:"¬øQui√©n escribi√≥ 'Pedro P√°ramo'?", options:["Juan Rulfo","Carlos Fuentes","Octavio Paz","Alejo Carpentier"], correct:0, difficulty:"hard"},
  {text:"¬øQu√© novela escribi√≥ Thomas Mann famosa por un doctor?", options:["La monta√±a m√°gica","Muerte en Venecia","Los Buddenbrook","Hans Castorp"], correct:0, difficulty:"hard"},
  {text:"Personaje: 'Randall Flagg' aparece en obras de...", options:["Stephen King","Clive Barker","Neil Gaiman","H.P. Lovecraft"], correct:0, difficulty:"hard"},
  {text:"¬øQui√©n escribi√≥ 'El proceso'?", options:["Franz Kafka","Joseph Conrad","Herman Melville","Gustave Flaubert"], correct:0, difficulty:"hard"},
  {text:"Objeto: 'Un diario que escribe el futuro' aparece en historias de...", options:["Ciencia ficci√≥n","Manual escolar","Recetas","Ensayo"], correct:0, difficulty:"hard"},
  {text:"¬øQu√© autor cre√≥ la figura de 'Raskolnikov'?", options:["Fi√≥dor Dostoyevski","Le√≥n Tolst√≥i","Ant√≥n Ch√©jov","Nicol√°s Gogol"], correct:0, difficulty:"hard"},
  {text:"Personaje: 'Stanis≈Çaw Wokulski' aparece en...", options:["Lalka (El sombrero)","El gran Gatsby","El idiota","Guerra y paz"], correct:0, difficulty:"hard"},
  {text:"¬øQui√©n escribi√≥ 'La invenci√≥n de Morel'?", options:["Adolfo Bioy Casares","Jorge Luis Borges","Alejandro Dolina","Horacio Quiroga"], correct:0, difficulty:"hard"},
  {text:"¬øQu√© obra es de Clarice Lispector?", options:["La hora de la estrella","Cien a√±os de soledad","El coronel no tiene quien le escriba","La tregua"], correct:0, difficulty:"hard"}
];

/* ===========================
   UTILIDADES Y SELECCI√ìN DE PARTIDA
   =========================== */

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function buildSequence(){
  // split pools
  const easy = QUESTIONS.filter(q=>q.difficulty==='easy').map((q,i)=>i);
  const med = QUESTIONS.filter(q=>q.difficulty==='med').map((q,i)=>i);
  const hard = QUESTIONS.filter(q=>q.difficulty==='hard').map((q,i)=>i);

  // indices above map to original QUESTIONS positions; need actual indices lists
  // We will build arrays of actual indices:
  const easyIdx = QUESTIONS.map((q,idx)=> q.difficulty==='easy' ? idx : -1).filter(i=>i!==-1);
  const medIdx = QUESTIONS.map((q,idx)=> q.difficulty==='med' ? idx : -1).filter(i=>i!==-1);
  const hardIdx = QUESTIONS.map((q,idx)=> q.difficulty==='hard' ? idx : -1).filter(i=>i!==-1);

  // shuffle each
  shuffle(easyIdx); shuffle(medIdx); shuffle(hardIdx);

  // pick 17 easy,17 med,16 hard
  const pickEasy = easyIdx.slice(0,17);
  const pickMed = medIdx.slice(0,17);
  const pickHard = hardIdx.slice(0,16);

  const combined = shuffle([...pickEasy, ...pickMed, ...pickHard]);
  sequence = combined;
  usedQuestions = [];
}

/* ===========================
   UI y flujo de juego
   =========================== */
const startBtn = document.getElementById('startBtn');
const recordsBtn = document.getElementById('recordsBtn');
const rulesBtn = document.getElementById('rulesBtn');
const musicBtn = document.getElementById('musicBtn');
const gameScreen = document.getElementById('gameScreen');
const clueEl = document.getElementById('clue');
const optionsEl = document.getElementById('options');
const livesEl = document.getElementById('lives');
const scoreEl = document.getElementById('score');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

startBtn.addEventListener('click', ()=>{ startGame(); });
recordsBtn.addEventListener('click', ()=>{ openOverlay('overlayRecords'); loadRankingUI(); });
rulesBtn.addEventListener('click', ()=>{ openOverlay('overlayRules'); });

musicBtn.addEventListener('click', ()=>{
  const m = document.getElementById('bgMusic');
  if(!musicOn){ m.volume = 0.25; m.play().catch(()=>{}); musicOn=true; musicBtn.innerText='üîä PAUSA'; }
  else { m.pause(); musicOn=false; musicBtn.innerText='üîä M√öSICA'; }
});

function startGame(){
  // reset
  lives = 6; score=0; currentIndex=0; document.getElementById('stampArea').style.display='none';
  updateStats();
  buildSequence();
  document.getElementById('overlayRecords').style.display='none';
  document.getElementById('overlayRules').style.display='none';
  gameScreen.style.display='block';
  startBtn.blur();
  loadQuestion();
}

function loadQuestion(){
  if(currentIndex >= sequence.length || lives <= 0){
    endGame();
    return;
  }
  const qIndex = sequence[currentIndex];
  const q = QUESTIONS[qIndex];
  clueEl.innerText = q.text;
  optionsEl.innerHTML = '';
  q.options.forEach((opt,i)=>{
    const b = document.createElement('div');
    b.className='opt';
    b.innerText = opt;
    b.onclick = ()=> checkAnswer(i);
    optionsEl.appendChild(b);
  });
  updateProgress();
}

function checkAnswer(choice){
  const qIndex = sequence[currentIndex];
  const q = QUESTIONS[qIndex];
  if(choice === q.correct){
    // correct
    score += 20; // arbitrary puntuation per correct
    playSound('sOk');
    currentIndex++;
    updateStats();
    // show next question after short delay to show effect
    setTimeout(()=>{ loadQuestion(); }, 250);
  } else {
    // incorrect
    lives--;
    playSound('sErr');
    updateStats();
    if(lives <= 0){ endGame(); return; }
    // stay on same question until correct
  }
  checkRankMilestones();
}

function updateStats(){
  livesEl.innerText = '‚ô•Ô∏é '.repeat(lives);
  scoreEl.innerText = score;
}

function updateProgress(){
  const done = currentIndex;
  const pct = Math.round((done / TOTAL_REQUIRED) * 100);
  progressBar.style.width = pct + '%';
  let rango = getRangeFor(done);
  progressText.innerText = `${done} / ${TOTAL_REQUIRED} ‚Äî Rango: ${rango || 'Ninguno'}`;
}

function getRangeFor(done){
  if(done >= 50) return 'Bibliomago Supremo';
  if(done >= 40) return 'Gran Erudito Arcano';
  if(done >= 25) return 'Aprendiz Ilustre';
  return null;
}

function checkRankMilestones(){
  const done = currentIndex;
  if(done === 25 || done === 40 || done === 50){
    // play sound and show mini animation/pop
    playSound('sRank');
    flashTitle();
  }
}

function flashTitle(){
  const el = document.querySelector('h1');
  el.style.transition = 'transform 300ms ease, text-shadow 300ms';
  el.style.transform = 'scale(1.02)';
  setTimeout(()=>{ el.style.transform='scale(1)'; }, 300);
}

/* ===========================
   End game & ranking flow
   =========================== */

function endGame(){
  gameScreen.style.display='none';
  // compute final score, maybe bonus for remaining lives
  if(lives>0){
    score += lives * 10;
    playSound('sWin');
  }
  // load ranking list and decide if in top 10
  getRanking().then(list=>{
    // list is array sorted desc {name,score,date}
    let lowest = list.length < 10 ? 0 : list[list.length-1].score;
    if(list.length < 10 || score > lowest){
      // show name prompt
      openOverlay('overlayName');
    } else {
      // show local ranking screen
      openOverlay('overlayRecords');
      renderRankingList(list);
    }
  }).catch(err=>{
    // fallback: local only
    let list = JSON.parse(localStorage.getItem(rankingLocalKey) || '[]');
    let lowest = list.length < 10 ? 0 : list[list.length-1].score;
    if(list.length < 10 || score > lowest) openOverlay('overlayName'); else { openOverlay('overlayRecords'); renderRankingList(list); }
  });
}

/* ========== overlay helpers ========== */
function openOverlay(id){ document.getElementById(id).style.display='flex'; }
function closeOverlay(id){ document.getElementById(id).style.display='none'; }

/* ========== Ranking storage (Firebase optional) ========== */

let db = null; // firestore instance

// call this to init firebase if you paste config
function initFirebase(firebaseConfig){
  if(!firebaseConfig) return;
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  firebaseEnabled = true;
}

// If firebaseEnabled use cloud, else localStorage
async function getRanking(){
  if(firebaseEnabled && db){
    const snap = await db.collection('ranking').orderBy('score','desc').limit(10).get();
    const arr = [];
    snap.forEach(doc => arr.push(doc.data()));
    return arr;
  } else {
    const raw = localStorage.getItem(rankingLocalKey) || '[]';
    return JSON.parse(raw);
  }
}

async function submitToRanking(name){
  const entry = {name: name.slice(0,20), score: score, date: new Date().toISOString()};
  if(firebaseEnabled && db){
    await db.collection('ranking').add(entry);
    // after add, fetch latest and render
    const list = await getRanking();
    renderRankingList(list);
    closeOverlay('overlayName');
    showStampIfElite(name);
  } else {
    // local fallback
    const arr = JSON.parse(localStorage.getItem(rankingLocalKey) || '[]');
    arr.push(entry);
    arr.sort((a,b)=>b.score-a.score);
    const top = arr.slice(0,10);
    localStorage.setItem(rankingLocalKey, JSON.stringify(top));
    renderRankingList(top);
    closeOverlay('overlayName');
    showStampIfElite(name);
  }
}

function submitName(){ const name = document.getElementById('playerName').value || 'An√≥nimo'; submitToRanking(name); }

/* ========== UI ranking render ========== */
async function loadRankingUI(){
  try{
    const list = await getRanking();
    renderRankingList(list);
  } catch(e){
    const arr = JSON.parse(localStorage.getItem(rankingLocalKey) || '[]');
    renderRankingList(arr);
  }
}

function renderRankingList(list){
  const container = document.getElementById('ranklist');
  container.innerHTML = '';
  list.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className='rankItem';
    const medal = i===0 ? 'ü•á' : i===1 ? 'ü•à' : i===2 ? 'ü•â' : 'üìö';
    const style = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
    div.innerHTML = `<div><span class="rankMedal">${medal}</span><strong class="${style}">${r.name}</strong></div><div>${r.score}</div>`;
    container.appendChild(div);
    // also show top3 on main header
    if(i===0) document.getElementById('p1').innerText=`ü•á ${r.name} ‚Äî ${r.score}`;
    if(i===1) document.getElementById('p2').innerText=`ü•à ${r.name} ‚Äî ${r.score}`;
    if(i===2) document.getElementById('p3').innerText=`ü•â ${r.name} ‚Äî ${r.score}`;
  });
  openOverlay('overlayRecords');
}

/* ===========================
   Stamps (generate image) using html2canvas
   =========================== */
function showStampIfElite(name){
  // check whether in top 3
  getRanking().then(list=>{
    const idx = list.findIndex(e=>e.name===name && e.score===score);
    if(idx>=0 && idx<=2){
      // show stamp area
      document.getElementById('stampArea').style.display='block';
      document.getElementById('stampCard').style.display='block';
      const rankText = idx===0 ? 'Bibliomago Supremo' : idx===1 ? 'Gran Erudito Arcano' : 'Aprendiz Ilustre';
      document.getElementById('stampTitle').innerText = rankText;
      document.getElementById('stampName').innerText = name;
      document.getElementById('stampMeta').innerText = `Puntaje: ${score} ‚Äî 2025`;
      // attach download/share
      document.getElementById('downloadStampBtn').onclick = ()=> {
        html2canvas(document.getElementById('stampCard')).then(canvas=>{
          const link = document.createElement('a');
          link.download = `estampa-${name.replace(/\s+/g,'_')}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      };
      document.getElementById('shareStampBtn').onclick = async ()=>{
        try{
          const canvas = await html2canvas(document.getElementById('stampCard'));
          const dataUrl = canvas.toDataURL('image/png');
          const blob = await (await fetch(dataUrl)).blob();
          const filesArray = [new File([blob], `estampa-${name}.png`, {type: 'image/png'})];
          if(navigator.canShare && navigator.canShare({files: filesArray})){
            navigator.share({files: filesArray, title:'Mi estampa literaria', text:`Soy ${rankText} en El Desaf√≠o del Bibliomago ‚Äî ${score} pts`});
          } else {
            alert('Compartir directo no est√° disponible en este dispositivo. Descarga la imagen y comp√°rtela manualmente.');
          }
        }catch(e){ alert('No fue posible compartir: '+e.message); }
      };
    } else {
      // not elite: show records
      openOverlay('overlayRecords');
    }
  });
}

function resetToMenu(){
  document.getElementById('stampArea').style.display='none';
  document.getElementById('stampCard').style.display='none';
  closeOverlay('overlayRecords');
  closeOverlay('overlayName');
  closeOverlay('overlayRules');
  gameScreen.style.display='none';
}

/* ===========================
   Sounds utility
   =========================== */
function playSound(id){
  try{
    const a = document.getElementById(id);
    if(a){ a.currentTime = 0; a.play().catch(()=>{}); }
  }catch(e){}
}

/* ===========================
   Particles background (simple)
   =========================== */
const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
const particles = [];
function spawnParticle(){
  particles.push({
    x: Math.random()*canvas.width,
    y: canvas.height + 10,
    vx: (Math.random()-0.5)*0.6,
    vy: - (0.2 + Math.random()*1.2),
    life: 200 + Math.random()*300,
    size: 1 + Math.random()*3,
    hue: Math.random()*360
  });
}
setInterval(()=>{ if(particles.length<80 && Math.random()>0.5) spawnParticle(); },120);
function updateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.life--;
    ctx.beginPath();
    const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.size*8);
    g.addColorStop(0,'rgba(126,249,255,0.9)');
    g.addColorStop(1,'rgba(255,126,249,0.02)');
    ctx.fillStyle = g;
    ctx.fillRect(p.x-p.size, p.y-p.size, p.size*2, p.size*2);
    if(p.life<=0 || p.y < -50) particles.splice(i,1);
  }
  requestAnimationFrame(updateParticles);
}
updateParticles();

/* ===========================
   OPTIONAL: FIREBASE CONFIG
   - If you want cloud ranking, paste your firebase config below
   - Example:
   const firebaseConfig = {
     apiKey: "xxx",
     authDomain: "xxx.firebaseapp.com",
     projectId: "xxx",
     storageBucket: "xxx.appspot.com",
     messagingSenderId: "xxx",
     appId: "xxx"
   };
   initFirebase(firebaseConfig);
   =========================== */

// --- PASTE YOUR FIREBASE CONFIG BELOW AND UNCOMMENT initFirebase(...) ---
// const firebaseConfig = { /* YOUR FIREBASE CONFIG HERE */ };
// if(firebaseConfig && firebaseConfig.apiKey) initFirebase(firebaseConfig);

</script>

</body>
</html>

